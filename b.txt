;WITH TargetWorkflows AS (
    SELECT DISTINCT EFT.WorkflowKey
    FROM dbo.tbl_EFT_Transfers EFT
    WHERE EFT.ClientKey = @TransferClientKey
      AND EFT.SiteCode = @TargetSiteCode
      AND EFT.WorkflowKey IS NOT NULL
)
INSERT dbo.tbl_WorkflowUsers
(
    WorkflowKey, Status, OpenDate, StatusDate, UserKey, Step, Type, ApprovalAmount
)
SELECT
    TW.WorkflowKey,
    0,
    SYSDATETIME(),
    SYSDATETIME(),
    @WorkFlowUserKey,
    1,
    1,
    NULL
FROM TargetWorkflows TW
WHERE NOT EXISTS (
    SELECT 1
    FROM dbo.tbl_WorkflowUsers WU
    WHERE WU.WorkflowKey = TW.WorkflowKey
);
