using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.Extensions.Options;
using Microsoft.IdentityModel.Tokens;

public void ConfigureServices(IServiceCollection services)
{
    // your existing pipeline:
    foreach (var startupConfiguration in _startupConfigurations)
        startupConfiguration.ConfigureServices(services);

    // âœ… Override the already-registered "Bearer" scheme
    services.PostConfigure<JwtBearerOptions>("Bearer", options =>
    {
        // 1) Fix "aud is array" validation issue
        options.TokenValidationParameters ??= new TokenValidationParameters();

        options.TokenValidationParameters.ValidAudiences = new[]
        {
            "agilink.claims",
            "agilink.documents",
            "agilink.files"
            // add "agilink.clients" if your token/API needs it
        };

        // 2) (Optional) tighten issuer if needed
        // options.TokenValidationParameters.ValidIssuer = "https://...";

        // 3) Add debug hooks (shows in VS Output window)
        options.Events ??= new JwtBearerEvents();
        options.Events.OnAuthenticationFailed = ctx =>
        {
            System.Diagnostics.Debug.WriteLine("AUTH FAILED: " + ctx.Exception);
            return Task.CompletedTask;
        };
        options.Events.OnChallenge = ctx =>
        {
            System.Diagnostics.Debug.WriteLine($"CHALLENGE: {ctx.Error} | {ctx.ErrorDescription}");
            return Task.CompletedTask;
        };
        options.Events.OnTokenValidated = ctx =>
        {
            System.Diagnostics.Debug.WriteLine("TOKEN VALIDATED OK");
            return Task.CompletedTask;
        };
    });

    services.AddControllers();
}
