using System.Data.Common;
using Microsoft.EntityFrameworkCore.Diagnostics;
using Microsoft.Extensions.Logging;

public sealed class EfSqlInterceptor : DbCommandInterceptor
{
    private readonly ILogger<EfSqlInterceptor> _logger;

    public EfSqlInterceptor(ILogger<EfSqlInterceptor> logger) => _logger = logger;

    public override InterceptionResult<DbDataReader> ReaderExecuting(
        DbCommand command, CommandEventData eventData, InterceptionResult<DbDataReader> result)
    {
        _logger.LogInformation("EF SQL ({Db})\n{Sql}", eventData.Context?.Database.ProviderName, command.CommandText);
        return result;
    }

    public override void CommandFailed(DbCommand command, CommandErrorEventData eventData)
    {
        _logger.LogError(eventData.Exception, "EF SQL FAILED\n{Sql}", command.CommandText);
    }
}


=======================================================

services.AddSingleton<EfSqlInterceptor>();

services.AddDbContext<AppDbContext>((sp, options) =>
{
    options.UseSqlServer(connectionString);
    options.AddInterceptors(sp.GetRequiredService<EfSqlInterceptor>());
});
